name: Preview
on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: PR number to deploy a preview for
        required: true
        type: number

concurrency:
  group: preview-pr-${{ github.event.pull_request.number || inputs.pr_number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  preview:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Resolve PR metadata
        id: pr
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # https://github.com/actions/github-script/releases/tag/v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const isDispatch = context.eventName === 'workflow_dispatch';
            let pr;

            if (isDispatch) {
              const prNumber = Number(context.payload.inputs?.pr_number);
              if (!prNumber) {
                core.setFailed('pr_number is required.');
                return;
              }

              const { data } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });
              pr = data;
            } else {
              pr = context.payload.pull_request;
            }

            core.setOutput('pr_number', String(pr.number));
            core.setOutput('head_repo', pr.head.repo.full_name);
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('is_draft', pr.draft ? 'true' : 'false');

      - name: Abort for draft PRs
        if: steps.pr.outputs.is_draft == 'true'
        run: |
          echo "Draft PRs do not get previews. Skipping preview deployment."
          exit 0

      - name: Resolve workers.dev subdomain
        id: workers_dev
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # https://github.com/actions/github-script/releases/tag/v8.0.0
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const accountId = process.env.CLOUDFLARE_ACCOUNT_ID;
            const token = process.env.CLOUDFLARE_API_TOKEN;

            if (!accountId || !token) {
              core.info('Skipping workers.dev subdomain lookup (missing Cloudflare credentials).');
              return;
            }

            const res = await fetch(`https://api.cloudflare.com/client/v4/accounts/${accountId}/workers/subdomain`, {
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
              },
            });

            const data = await res.json();
            if (!data?.success) {
              core.info(`workers.dev subdomain lookup failed: ${JSON.stringify(data?.errors || data)}`);
              return;
            }

            if (data.result?.subdomain) {
              core.setOutput('subdomain', data.result.subdomain);
            }

      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # https://github.com/actions/checkout/releases/tag/v6.0.0
        with:
          repository: ${{ steps.pr.outputs.head_repo }}
          ref: ${{ steps.pr.outputs.head_sha }}
          fetch-depth: 2
          persist-credentials: false

      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # https://github.com/pnpm/action-setup/releases/tag/v4.2.0
        with:
          version: 10
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # https://github.com/actions/setup-node/releases/tag/v6.0.0
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Cache Next.js
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # https://github.com/actions/cache/releases/tag/v4.3.0
        with:
          path: ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-

      - name: Cache Compiled MDX
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # https://github.com/actions/cache/releases/tag/v4.3.0
        with:
          path: ${{ github.workspace }}/.compiled-mdx
          key: ${{ runner.os }}-compiled-mdx-${{ hashFiles('src/app/content/**/*.mdx', 'src/lib/shiki/*.json') }}
          restore-keys: |
            ${{ runner.os }}-compiled-mdx-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Precompile MDX
        run: pnpm precompile-mdx

      - name: Derive preview identifiers
        env:
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
          WORKERS_DEV_SUBDOMAIN: ${{ steps.workers_dev.outputs.subdomain }}
        run: |
          PR_NUMBER="${PR_NUMBER}"
          echo "WORKER_NAME=blueshift-preview-pr-${PR_NUMBER}" >> "$GITHUB_ENV"
          echo "CONTENT_PREFIX=compiled-mdx-preview/pr-${PR_NUMBER}" >> "$GITHUB_ENV"

          if [ -n "${WORKERS_DEV_SUBDOMAIN}" ]; then
            echo "PREVIEW_URL=https://blueshift-preview-pr-${PR_NUMBER}.${WORKERS_DEV_SUBDOMAIN}.workers.dev" >> "$GITHUB_ENV"
          fi

      - name: Upload Compiled MDX to R2 (preview)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          ENDPOINT: https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
          COMPILED_DIR: .compiled-mdx
          CONTENT_DIR: src/app/content
        run: |
          S3_PREFIX="s3://${{ secrets.R2_BUCKET }}/$CONTENT_PREFIX"

          # Size-only sync first (handles new files, size changes, and deletions efficiently)
          aws s3 sync "$COMPILED_DIR/" "$S3_PREFIX" \
            --endpoint-url "$ENDPOINT" \
            --no-progress \
            --size-only \
            --delete \
            --content-type "application/json"

          # Then force-upload any files changed in this commit (catches same-size content edits)
          # Skip if this is the first commit
          if git rev-parse --verify HEAD^ >/dev/null 2>&1; then
            changed_files=$(git diff --name-only --diff-filter=ACM HEAD^ "$CONTENT_DIR/" | grep '\.mdx$' || echo "")

            for file in $changed_files; do
              # Convert .mdx path to .json path in compiled directory
              relative_path="${file#$CONTENT_DIR/}"
              json_path="${relative_path%.mdx}.json"
              compiled_file="$COMPILED_DIR/$json_path"

              if [ -f "$compiled_file" ]; then
                aws s3 cp "$compiled_file" "$S3_PREFIX/$json_path" \
                  --endpoint-url "$ENDPOINT" \
                  --no-progress \
                  --content-type "application/json"
              fi
            done
          fi

      - name: Build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_CHALLENGE_SECRET: ${{ secrets.NEXT_PUBLIC_CHALLENGE_SECRET }}
          NEXT_PUBLIC_CHALLENGE_RPC_ENDPOINT: ${{ secrets.NEXT_PUBLIC_CHALLENGE_RPC_ENDPOINT }}
          NEXT_PUBLIC_MAINNET_RPC_ENDPOINT: ${{ secrets.NEXT_PUBLIC_MAINNET_RPC_ENDPOINT }}
          NEXT_PUBLIC_DEVNET_RPC_ENDPOINT: ${{ secrets.NEXT_PUBLIC_DEVNET_RPC_ENDPOINT }}
        run: pnpm exec opennextjs-cloudflare build

      - name: Deploy Preview (workers.dev)
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # https://github.com/cloudflare/wrangler-action/releases/tag/v3.14.1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: >
            deploy --env preview
            --name ${{ env.WORKER_NAME }}
            --var CONTENT_PREFIX:${{ env.CONTENT_PREFIX }}

      - name: Comment preview URL
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # https://github.com/actions/github-script/releases/tag/v8.0.0
        env:
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
          PREVIEW_URL: ${{ env.PREVIEW_URL }}
          WORKER_NAME: ${{ env.WORKER_NAME }}
          CONTENT_PREFIX: ${{ env.CONTENT_PREFIX }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = Number(process.env.PR_NUMBER);
            const marker = '<!-- preview-link -->';
            const body = `${marker}\nâœ… Preview deployed: ${process.env.PREVIEW_URL}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existing = comments.find((comment) => comment.body && comment.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }
